---
title: "reQTL Poisson Mixed Model Example"
author: Genevieve Roberts
output:
  pdf_document:
    latex_engine: pdflatex  # Specify the LaTeX engine
date: "2024-06-14"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
options(warn = -1)
library(knitr)
library(kableExtra)
library(pander)
```

## Load Packages

```{r packages}
library(lme4)
library(lmerTest)
library(emmeans)
library(data.table)
library(here)
library(dplyr)
library(stringr)
library(tidyr)
library(tibble)
library(purrr)
library(ggplot2)
library(broom)
library(broom.mixed)
```
\newpage

## Why use an interaction regression model?
An interaction model allows us to look at the differences in the slopes between
genotypes.

## Simulate Data for a reQTL

```{r}
#Simulate some data with an interaction effect
library(tibble)
library(dplyr)

simulate_expression_data <- function(n_donors = 80,
                                     p_minor_allele = 0.3,
                                     interaction_effect_magnitude = 0.5,
                                     snp_id="SNP1") {
  # Function to simulate genotype frequencies according to Hardy-Weinberg equilibrium
  simulate_genotype <- function(n, p_minor_allele) {
    p_major_allele <- 1 - p_minor_allele
    sample(0:2, size = n, replace = TRUE, prob = c(p_major_allele^2,
                                                   2 * p_major_allele * p_minor_allele,
                                                   p_minor_allele^2))
  }
  
  # Simulate the dataframe
  df <- tibble(
    donor = rep(1:n_donors, each = 2),
    IFNg_treatment = rep(c(TRUE, FALSE), n_donors),
    genotype = rep(simulate_genotype(n_donors, p_minor_allele), each = 2)
  )
  
  # Add the interaction effect and simulate expression values
  df <- df %>%
    mutate(
      interaction_effect = 1 + IFNg_treatment * genotype * interaction_effect_magnitude,
      expression_value = rpois(n = n(), lambda = interaction_effect * 20) # Scale lambda
    ) %>%
    mutate(snp_id = snp_id) %>%
    select(snp_id, donor, IFNg_treatment, genotype, expression_value)
  
  return(df)
}

set.seed(123)
df <- simulate_expression_data(n_donors = 80,
                               p_minor_allele = 0.3,
                               interaction_effect_magnitude = 0.5)

# View the first few rows of the simulated dataframe
pander(head(df))
```
\newpage

## Fit the Negative Binomial Mixed Effects Regression Model & Interperet Interaction Term
```{r}
# Fit negative binomial regression with random intercept (the outcome looks like count data)
poisson_model <- glmer.nb(expression_value ~ IFNg_treatment*genotype + (1 | donor),
                       data = df)

#clean-up the model output and pull the interaction term
tidy_poisson <- tidy(poisson_model)
tidy_poisson %>% pander()
```
The estimate (AKA beta) for the interaction term IFNg_treatmentTRUE:genotype is 0.40, with a p-value of 2.5e-14:

- The estimate of 0.40 means that for each one-unit increase in genotype, the log of the expected expression_value count increases by 0.40 when the treatment is TRUE. Exponentiating this, exp(0.40)=1.49, suggests that the expected count of expression_value is approximately 49% higher for each additional minor allele when the treatment is applied compared to when it is not.

- The p-value of 2.5e-14  indicates that this interaction effect is statistically significant at the 5% level, meaning there is strong evidence that the effect of genotype on expression_value is indeed influenced by whether or not the cells were treated with IFNg. Thus, this SNP is a significant reQTL.

\newpage

### Simulate both a real reQTL and no eQTL
```{r}

# Parameters for the SNPs
snp_params <- tibble(
  n_donors = 80,
  p_minor_allele = 0.3,
  interaction_effect_magnitude = c(0.8, 0.25, 0),  # Large interaction effect vs no interaction effect
  snp_id = c("Strong reQTL SNP", "Weak reQTL SNP", "Regular SNP")
)

# Simulate data for each SNP and combine into one dataframe
combined_df <- pmap_df(snp_params, ~ simulate_expression_data(..1, ..2, ..3, ..4))

# View the first few rows of the combined dataframe
pander(head(combined_df))
```
\newpage

## Fit the Negative Binomial Mixed Effects Regression Model for Each SNP
```{r}
# Function to fit Poisson regression model and extract the interaction term for each SNP
fit_poisson_and_extract <- function(data) {
  snp_ids <- unique(data$snp_id)
  
  # Define a function to fit the model and extract the interaction term for a given SNP
  fit_and_extract <- function(snp_id) {
    # Filter data for the current SNP
    df_snp <- data %>% filter(snp_id == {{ snp_id }})
    
    # Fit the Poisson regression model
    poisson_model <- glmer.nb(expression_value ~ IFNg_treatment * genotype + (1 | donor),
                           data = df_snp)
    
    # Clean up and pull the interaction term
    tidy_poisson <- tidy(poisson_model)
    interaction_term <- tidy_poisson %>%
      filter(str_detect(term, ":")) %>%
      select(term, estimate, p.value)
    
    # Add SNP identifier to the results
    interaction_term <- interaction_term %>%
      mutate(snp_id = snp_id) %>%
      select(snp_id, everything())
    
    return(interaction_term)
  }
  
  # Apply the function to each SNP and combine the results into one data frame
  results <- map_df(snp_ids, fit_and_extract)
  
  return(results)
}

sum_stats <- fit_poisson_and_extract(combined_df)
pander(sum_stats)
```
\newpage

## Plot the Data with P-values to Demonstrate
```{r}
# Merge the SNP table with your combined_df
combined_df_annotated <- combined_df %>%
  left_join(sum_stats, by = "snp_id") %>%
  mutate(`Percentage Increase` = (exp(estimate) - 1) * 100)

# Create the plot
ggplot(combined_df_annotated, aes(x = factor(IFNg_treatment),
                                  y = expression_value, color = factor(genotype))) +
  geom_point(alpha = 0.6) +
  geom_line(aes(group = donor, color = factor(genotype)), alpha = 0.6) + 
  labs(
    title = "Interaction between Genotype and IFNg_treatment on Expression Value",
    x = "IFNg Treatment",
    y = "Expression Value",
    color = "Genotype"
  ) +
  facet_grid(".~snp_id") +
  theme_bw() +
  geom_text(data = combined_df_annotated %>% distinct(snp_id, p.value, `Percentage Increase`),
            aes(x = Inf, y = Inf, label = paste("P-value:",
                                                format(p.value, digits = 2),
                                                "\n Increase per Allele:",
                                                format(`Percentage Increase`, digits = 2),
                                                "%")),
            hjust = 1.1, vjust = 1.1, size = 3, color = "black", fontface = "italic") +
  theme(strip.text = element_text(size = 12)) # Adjust facet label text size if needed

```
\newpage

```{r}
# Create the plot
ggplot(combined_df_annotated, aes(x = factor(genotype),
                                  y = expression_value, color = factor(IFNg_treatment))) +
  geom_point(alpha = 0.6) +
  labs(
    title = "Interaction between Genotype and IFNg treatment on Expression Value",
    x = "Genotype",
    y = "Expression Value",
    color = "IFNg Treatment"
  ) +
  facet_grid("factor(IFNg_treatment)~snp_id") +
  theme_bw() 
```


\newpage

# Explore the real data

```{r}

#load the real data
real_dat <- read.csv(here::here("notebooks/long_form_reQTL_data.csv")) %>%
  arrange(donor)

#make sure the reference group is set to "PBS"
real_dat$condition <- relevel(factor(real_dat$condition), ref = "PBS")
real_dat$genotype.nt <- relevel(factor(real_dat$genotype.nt), ref = "TT")
```


## Plot the real data

```{r}
# Create the plot

# Reshape to long format for faceting
real_dat_plot <- real_dat %>%
  pivot_longer(cols = c(counts, CPM), names_to = "scale_type", values_to = "expression_value")

# Create the plot
ggplot(real_dat_plot, aes(x = factor(condition),
                          y = expression_value,
                          color = factor(genotype.num))) +
  geom_point(alpha = 0.6) +
  geom_line(aes(group = donor), alpha = 0.6) + 
  labs(
    title = "Interaction between Genotype and IFNg_treatment on Expression",
    x = "IFNg Treatment",
    y = "Expression Value",
    color = "Genotype"
  ) +
  facet_wrap(scale_type ~ phase, scales = "free_y") +
  theme_bw()
```

## Fit a linear mixed effects model
```{r}
# Fit the Poisson regression model
real_linear_model <- lmer(counts ~ condition * genotype.num  +
                            #(1 + condition | phase) + #random slope for phase
                            (1 | phase/donor), #random intercept for donor, nested within phase
                           data = real_dat)
    
# Clean up and pull the interaction term
real_tidy_linear <- tidy(real_linear_model)
real_interaction_term <- real_tidy_linear %>%
  filter(str_detect(term, ":")) %>%
  select(term, estimate, p.value)

real_tidy_linear
```


## Fit the Negative Binomial Mixed Effects Regression Model on the Real Data
```{r}
# Fit the Poisson regression model
real_poisson_model <- glmer.nb(counts ~ condition * genotype.num +
                                 (1 | phase) +
                                 (1 | phase:donor),
                               data = real_dat)
    
# Clean up and pull the interaction term
real_tidy_poisson <- tidy(real_poisson_model)
real_interaction_term <- real_tidy_poisson %>%
  filter(str_detect(term, ":")) %>%
  select(term, estimate, p.value)

real_tidy_poisson
```
```{r}
# Fit a reduced model
real_poisson_model_red <- glmer.nb(counts ~ condition + genotype.nt + (1 | donor),
                           data = real_dat)

# Fit the Poisson regression model
real_poisson_model <- glmer.nb(counts ~ condition * genotype.nt + (1 | donor),
                           data = real_dat)

# Do a likelihood ratio test
anova(real_poisson_model_red, real_poisson_model, test = "LRT")
```




```{r}
generate_permuted_null <- function(model_formula,
                                   data,
                                   interaction_term_regex = ":",
                                   permute_var = NULL,
                                   n_perm = 100,
                                   model_type = c("lmer", "glmer", "glmer.nb", "glm"),
                                   family = poisson) {
  
  model_type <- match.arg(model_type)
  model_formula_str <- paste(deparse(model_formula), collapse = " ")
  
  # Determine outcome variable for permutation
  if (is.null(permute_var)) {
    outcome_var <- all.vars(model_formula)[1]
  } else {
    outcome_var <- permute_var
  }
  
  # Fit the model to the observed data
  fit_model <- switch(
    model_type,
    lmer     = lmer(model_formula, data = data),
    glmer    = glmer(model_formula, data = data, family = family),
    glmer.nb = glmer.nb(model_formula, data = data),
    glm      = glm(model_formula, data = data, family = family)
  )
  
  # Extract observed interaction term results
  observed_results <- tidy(fit_model) %>%
    filter(str_detect(term, interaction_term_regex)) %>%
    select(term, estimate, statistic = any_of("statistic"), p.value) %>%
    mutate(type = "observed")
  
  # Generate permuted results
  permuted_results <- map_dfr(1:n_perm, function(i) {
    permuted_data <- data %>%
      mutate(!!sym(outcome_var) := sample(!!sym(outcome_var)))
    
    perm_model <- tryCatch({
      switch(
        model_type,
        lmer     = lmer(model_formula, data = permuted_data),
        glmer    = glmer(model_formula, data = permuted_data, family = family),
        glmer.nb = glmer.nb(model_formula, data = permuted_data),
        glm      = glm(model_formula, data = permuted_data, family = family)
      )
    }, error = function(e) return(NULL))
    
    if (is.null(perm_model)) return(tibble())
    
    tidy(perm_model) %>%
      filter(str_detect(term, interaction_term_regex)) %>%
      select(term, estimate, statistic = any_of("statistic"), p.value) %>%
      mutate(type = "null")
  })
  
  # Combine and annotate
  bind_rows(observed_results, permuted_results) %>%
    mutate(model_formula = model_formula_str)
}



plot_qq_pvalue <- function(sim_df) {
  model_formula <- unique(sim_df$model_formula)
  null_pvalues <- sim_df %>% filter(type == "null") %>% pull(p.value)
  observed_pval <- sim_df %>% filter(type == "observed") %>% pull(p.value)

  empirical_pval <- mean(null_pvalues <= observed_pval, na.rm = TRUE)

  qq_df <- data.frame(
    expected = -log10(ppoints(length(null_pvalues))),
    observed = -log10(sort(null_pvalues)),
    type = "null"
  )

  observed_point <- data.frame(
    expected = -log10(0.5 / length(null_pvalues)),
    observed = -log10(observed_pval),
    label = paste0("Empirical p = ", signif(empirical_pval, 3))
  )

  ggplot(qq_df, aes(x = expected, y = observed)) +
    geom_point(alpha = 0.4) +
    geom_abline(slope = 1, intercept = 0, color = "gray") +
    geom_point(data = observed_point, aes(x = expected, y = observed), color = "red", size = 3) +
    geom_text(data = observed_point, aes(label = label), vjust = -1.5, color = "red") +
    labs(x = "Expected -log10(p)", y = "Observed -log10(p)",
         title = "QQ Plot of Permuted vs Observed Interaction P-Value",
         subtitle = paste("Model:", model_formula),) +
    theme_bw()
}
```


### Nested phase/donor
```{r}
###test the functions
null_results <- generate_permuted_null(
  model_formula = CPM ~ condition * genotype.num + (1 | phase/donor),
  data = real_dat,
  n_perm = 500,
  model_type = "lmer"
)

plot_qq_pvalue(null_results)
```

### Just donor
```{r}
null_results <- generate_permuted_null(
  model_formula = CPM ~ condition * genotype.num + (1 | donor),
  data = real_dat,
  n_perm = 500,
  model_type = "lmer"
)

plot_qq_pvalue(null_results)
```


### No random effect
```{r}
null_results <- generate_permuted_null(
  model_formula = CPM ~ condition * genotype.num,
  data = real_dat,
  n_perm = 500,
  model_type = "glm",
  family=gaussian()
)

plot_qq_pvalue(null_results)
```
